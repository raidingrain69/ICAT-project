<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Passwordless Blockchain Login</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
<style>
body { 
    background-color: aqua; 
    text-align:center; 
    font-family: Arial, sans-serif; 
}
button { 
    background-color: rgb(57, 255, 47); 
    border-radius: 20px; 
    padding: 10px; 
    margin: 10px; 
    cursor:pointer; 
}
#Protectedcontent { 
    margin-top:20px; 
    display:none; 
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    width: 50%;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 2px 2px 10px gray;
}
</style>
</head>
<body>

<h1>Passwordless Login Using Blockchain</h1>

<button id="connectBtn">Connect Wallet</button>
<button id="loginBtn" style="display:none;">Login (Sign Message)</button>

<div id="Protectedcontent">
<h2>Protected Content</h2>
<p id="usermessage"></p>
<p>This content is only viewable if authenticated with your wallet.</p>
</div>

<script>
let provider, signer, userAddress;

const connectBtn = document.getElementById('connectBtn');
const loginBtn = document.getElementById('loginBtn');
const Protectedcontent = document.getElementById('Protectedcontent');
const usermessage = document.getElementById('usermessage');

// STEP 1: CONNECT WALLET
connectBtn.addEventListener('click', async () => {
    if(typeof window.ethereum === 'undefined'){
        alert("MetaMask not installed");
        return;
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    usermessage.innerHTML = `Wallet connected: <b>${userAddress}</b>`;
    loginBtn.style.display = 'inline-block';
});

// STEP 2: LOGIN USING CHALLENGE-RESPONSE
loginBtn.addEventListener('click', async () => {
    try {
        // 1️⃣ Get challenge from local backend
        const challengeResp = await fetch('http://127.0.0.1:5000/challenge', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({address: userAddress})
        });
        const challengeData = await challengeResp.json();
        const challenge = challengeData.challenge;

        // 2️⃣ User signs challenge with private key
        const signature = await signer.signMessage(challenge);

        // 3️⃣ Send signature back to backend for verification
        const verifyResp = await fetch('http://127.0.0.1:5000/verify', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({address: userAddress, challenge: challenge, signature: signature})
        });

        const verifyData = await verifyResp.json();

        if(verifyData.status === 'success'){
            Protectedcontent.style.display = 'block';
            usermessage.innerHTML = `Logged in as <b>${userAddress}</b><br>Authentication successful via cryptographic signature (no password).`;
        } else {
            alert("Authentication failed: " + verifyData.message);
        }
    } catch(error){
        console.error("Error during login:", error);
        alert("Error during login. Check backend is running.");
    }
});
</script>

</body>
</html>
