<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My ICAT Project</title>

    <style>
        body { background-color: aqua; }
        h1 { text-align: center; }
        button {
            background-color: rgb(57, 255, 47);
            border-radius: 20px;
            padding: 10px;
            margin-left: 39%;
            cursor: pointer;
        }
    </style>

    <!-- ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"
        integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>

<h1>Passwordless Login Using Blockchain</h1>

<button id="connectBtn">Connect Wallet</button>
<br><br>
<button id="loginBtn" style="display:none;">Login (Sign Message)</button>

<div id="Protectedcontent">
    <h2>Protected Content</h2>
    <p id="usermessage"></p>
    <p>This content is only viewable if you're authenticated using your wallet.</p>
</div>

<script>
    const connectBtn = document.getElementById('connectBtn');
    const loginBtn = document.getElementById('loginBtn');
    const Protectedcontent = document.getElementById('Protectedcontent');
    const usermessage = document.getElementById('usermessage');

    Protectedcontent.style.display = 'none';

    let provider;
    let signer;
    let userAddress;

    // STEP 1: CONNECT WALLET
    connectBtn.addEventListener("click", async () => {
        if (typeof window.ethereum === 'undefined') {
            alert("MetaMask is not installed!");
            return;
        }

        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        usermessage.innerHTML = `Wallet connected: <b>${userAddress}</b>`;
        loginBtn.style.display = "inline-block";
    });

    // STEP 2: LOGIN USING CHALLENGEâ€“RESPONSE
    loginBtn.addEventListener("click", async () => {

        /*
          In real project:
          1. Backend sends challenge
          2. User signs it
          3. Backend verifies signature
        */

        // TEMP challenge (later this comes from Flask backend)
        const challenge = "LOGIN_CHALLENGE_" + Math.floor(Math.random() * 1000000);

        // User signs challenge with private key
        const signature = await signer.signMessage(challenge);

        console.log("Challenge:", challenge);
        console.log("Signature:", signature);

        // Normally you'd send this to backend:
        /*
        fetch('/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                address: userAddress,
                challenge: challenge,
                signature: signature
            })
        })
        */

        // TEMP success (frontend-only demo)
        Protectedcontent.style.display = 'block';
        usermessage.innerHTML = `
            Logged in as <b>${userAddress}</b><br>
            Authentication done via cryptographic signature (no password).
        `;
    });
</script>

</body>
</html>
