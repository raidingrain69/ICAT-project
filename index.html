<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Passwordless Blockchain Login</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>

<style>
body {
  background: linear-gradient(-45deg, #1f1c2c, #928dab, #1f1c2c, #928dab);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}
@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

button { 
    background-color: rgb(57, 255, 47); 
    border-radius: 20px; 
    padding: 10px; 
    margin: 10px; 
    cursor:pointer; 
}
#Protectedcontent { 
    margin-top:20px; 
    display:none; 
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 2px 2px 10px gray;
}

.box {
  width: 400px;
  background-color: rgba(65, 208, 25, 0.423);
  border: 2px solid #000;
  padding: 20px;
  margin: 40px auto;   /* centers horizontally */
  border-radius: 20px;
  box-shadow: 15px 15px 25px rgba(151, 27, 27, 0.3);
}

#names {
  text-align: left;
  margin-top: 20px;
  background-color: rgba(65, 208, 25, 0.423);
  border: 2px solid #000;
  padding: 15px;
  width: 400px;
  margin-left: auto;
  margin-right: auto;
  border-radius: 20px;
  box-shadow: 15px 15px 20px rgba(122, 230, 5, 0.2);
}

.rgb-border {
  position: relative;
  padding: 20px;
  border-radius: 12px;
  background: rgba(12, 214, 137, 0.859);
  z-index: 0;
}




.names-content table {
  width: 100%;
  border-collapse: collapse;
}

.names-content td {
  padding: 4px 8px;
}

.names-content td:first-child {
  text-align: left;   /* names aligned left */
}

.names-content td:last-child {
  text-align: right;  /* IDs aligned right */
  font-weight: bold;  /* optional styling */
}



/* Fancy Toast Animation with slide, pop, and auto-slide-out */
#toast {
  visibility: hidden;
  min-width: 250px;
  margin-left: -125px;
  background-color: #4BB543; /* green */
  color: white;
  text-align: center;
  border-radius: 12px;
  padding: 16px;
  position: fixed;
  z-index: 100;
  left: 50%;
  top: -100px; /* start off-screen */
  font-size: 16px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
  opacity: 0;
  transform: translateY(0) scale(0.9);
  transition: opacity 0.5s ease, top 0.5s ease, transform 0.5s ease;
}

#toast.show {
  visibility: visible;
  opacity: 1;
  top: 30px; /* slide down */
  transform: translateY(0) scale(1.05); /* subtle pop */
}

#toast.show::after {
  content: "";
  display: block;
  height: 4px;
  width: 0%;
  background: rgba(255,255,255,0.8);
  animation: progressBar 3s linear forwards;
  margin-top: 8px;
  border-radius: 2px;
}

@keyframes progressBar {
  0% { width: 0%; }
  100% { width: 100%; }
}


</style>
</head>
<body>
<div class="box rgb-border">
<h1>Passwordless Login Using Blockchain</h1>

<button id="connectBtn">Connect Wallet</button>
<button id="loginBtn" style="display:none;">Login (Sign Message)</button>

<div id="Protectedcontent">
<h2>Protected Content</h2>
<p id="usermessage"></p>
<p>This content is only viewable if authenticated with your blockchain wallet.</p>
</div>
</div>

<br>
<br>
<br>
<br> 
<br>


<div id="names" class="rgb-border">
<div class="names-content">
  <p>ICAT project by:</p>
  <table>
    <tr><td>Ali Shahnawaz : </td> <td>F25609038</td></tr>
    <tr><td>Muhammad Abdullah Ali : </td><td>F25609048</td></tr>
    <tr><td>Muhammad Hadi Shah : </td><td>F25609009</td></tr>
    <tr><td>Abdullah Faheem : </td><td>F25609030</td></tr>
    <tr><td>Hamid Rauf : </td><td>F25609044</td></tr>
  </table>
</div>

</div>


<script>
let provider, signer, userAddress, didContract;

// HTML elements
const connectBtn = document.getElementById('connectBtn');
const registerBtn = document.createElement('button');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.createElement('button');
const Protectedcontent = document.getElementById('Protectedcontent');
const usermessage = document.getElementById('usermessage');

// Setup Register and Logout buttons
registerBtn.innerText = "Register Wallet";
registerBtn.style.display = "none";
registerBtn.style.margin = "10px";
connectBtn.parentNode.insertBefore(registerBtn, loginBtn);

logoutBtn.innerText = "Logout";
logoutBtn.style.display = "none";
logoutBtn.style.margin = "10px";
connectBtn.parentNode.insertBefore(logoutBtn, loginBtn.nextSibling);

// DID contract info
const didContractAddress = "0xb839b888c9aE29DD1A658843BF27b3c657E27b8c";
const didAbi = [
    "function isRegistered(address _user) view returns (bool)",
    "function register()"
];

// --- Connect Wallet ---
connectBtn.addEventListener('click', async () => {
    if (!window.ethereum) { alert("MetaMask not installed"); return; }

    try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== 11155111) {
            alert(`Please switch MetaMask to Sepolia. Current network: ${network.name}`);
            return;
        }

        // Initialize contract (read-only by default)
        didContract = new ethers.Contract(didContractAddress, didAbi, provider);

        const isRegistered = await didContract.isRegistered(userAddress);
        console.log("DID check result:", isRegistered);

        if (!isRegistered) {
            alert("Wallet not registered. Click 'Register Wallet' to register.");
            registerBtn.style.display = "inline-block";
            loginBtn.style.display = "none";
        } else {
            usermessage.innerHTML = `Wallet connected: <b>${userAddress}</b>`;
            loginBtn.style.display = "inline-block";
        }

    } catch(err) {
        console.error("Error connecting wallet / checking DID:", err);
        alert("Error connecting wallet. Check console.");
    }
});

// --- Register Wallet ---
registerBtn.addEventListener('click', async () => {
    try {
        if (!didContract) return alert("Connect wallet first.");
        const contractWithSigner = didContract.connect(signer);
        const tx = await contractWithSigner.register();
        await tx.wait(); // wait for transaction to confirm
        showToast("Wallet successfully registered!");
        registerBtn.style.display = "none";
        loginBtn.style.display = "inline-block";
        usermessage.innerHTML = `Wallet connected: <b>${userAddress}</b>`;
    } catch(err) {
        console.error("Registration error:", err);
        alert("Failed to register wallet. Check console.");
    }
});

// --- Login (Challenge-Response) ---
loginBtn.addEventListener('click', async () => {
    try {
        const challengeResp = await fetch('http://127.0.0.1:5000/challenge', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({address: userAddress})
        });
        const challengeData = await challengeResp.json();
        const challenge = challengeData.challenge;

        const signature = await signer.signMessage(challenge);

        const verifyResp = await fetch('http://127.0.0.1:5000/verify', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({address: userAddress, challenge: challenge, signature: signature})
        });
        const verifyData = await verifyResp.json();

        if (verifyData.status === 'success') {
            Protectedcontent.style.display = 'block';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            usermessage.innerHTML = `Logged in as <b>${userAddress}</b><br>Authentication successful via signature.`;
            showToast("Login successful!");
        } else {
            alert("Authentication failed: " + verifyData.message);
        }

    } catch(err) {
        console.error("Login error:", err);
        alert("Error during login. Check backend.");
    }
});

// --- Logout ---
logoutBtn.addEventListener('click', () => {
    Protectedcontent.style.display = 'none';
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    usermessage.innerHTML = "";
});

// Function to show animated toast
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.innerText = message;
    toast.className = 'show';
    
    // Slide out after 3s
    setTimeout(() => { 
        toast.style.top = '-100px'; // move up off-screen
        toast.style.opacity = '0';
        toast.style.transform = 'scale(0.9)';
        setTimeout(() => { toast.className = ''; toast.style.top = '30px'; }, 500); // reset for next toast
    }, 3000);
}

// Example usage:
// showToast("Wallet registered successfully!");
// showToast("Login successful!");

</script>


<div id="toast"></div>


</body>
</html>
